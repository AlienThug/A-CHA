clear;
clc;
format long

data_S = [0	0	0	0	0	0
177.64691	84.60179	18.30626	5.03124	4.18505	3.75642
287.31324	145.69321	37.03555	13.40539	10.52477	9.20649
384.42785	201.76835	56.19556	22.57197	17.26689	15.75852
449.50402	247.22275	77.4394	33.71161	24.99045	23.56802
496.50764	287.31319	101.87549	46.47615	33.76664	32.16138
530.9947	324.26726	129.85531	61.84668	43.61915	41.08868
553.72895	359.66001	161.57629	80.33202	54.83168	49.65029
568.94615	393.01855	195.95513	101.98447	67.99914	58.01088
579.08839	424.07459	233.13883	127.35814	83.00279	66.54892
584.8692	452.60314	273.11727	156.28064	99.47404	75.56937
588.46792	478.24289	314.36425	187.67434	117.75692	84.75408
590.52956	500.67246	354.56218	221.70742	137.72998	94.92723
591.28548	520.94339	394.56344	258.25808	159.49712	105.32649
592.16379	537.73215	428.28403	294.77585	184.08335	115.87079
592.63534	552.19186	457.55389	330.54991	211.72878	126.95854
593.43184	563.85918	482.61206	363.43471	241.27441	138.46307
594.47772	574.32431	503.12765	393.69999	272.55616	149.8364
596.08516	582.13601	523.26935	418.6741	303.4039	162.01524
];
data_No_S = [0	0	0	0	0	0
225.13655	107.76102	34.94136	14.43235	7.05799	7.2206
351.08751	175.95543	63.65929	31.22984	18.03197	11.08126
421.12659	218.15725	86.71222	44.05597	25.90368	20.05961
465.19	259.71605	105.57044	57.92453	35.00301	25.82725
480.63499	288.88959	126.1009	67.071	42.76261	32.13845
489.52273	315.53943	144.72279	80.26523	48.89818	37.78315
491.74921	341.65701	156.35962	91.566	55.76507	43.73476
498.94476	363.44261	173.01659	102.31123	64.86729	48.22835
502.00051	381.70102	183.65292	111.22981	71.94915	51.92034
501.55019	407.29978	198.40092	121.56776	79.39419	58.21984
503.8278	413.21109	211.85574	130.75055	85.76869	61.69597
507.15479	431.05384	229.1564	142.57561	94.03616	63.75993
512.77244	447.21271	235.78474	153.02139	99.7547	67.74635
509.94108	456.66692	249.02396	158.64868	108.3522	70.05555
513.47752	475.40847	264.80665	170.54617	114.1547	75.77379
519.56899	472.49615	274.96892	181.50252	121.42402	77.51748
522.40151	489.65509	280.03639	191.6864	128.57715	80.02024
525.43058	490.15015	293.73185	200.10773	135.42065	83.7643
];

global k1 k2 N s count tspan x0 T kp Yp p ii jj k1a k2a a
% k1 refers kinetic constant that I catalyze
% k2 refers kinetic constant that H1-H2-H3 catalyze
% N refers numerical value of k1/k2
% s refers the location where the max R is
% count saves the fluorescence intensity value of each simulation
% tspan refers integration interval
% x0 refers initial concentrations of each species
% T refers initial concentrations of each I
% kp saves the most suitable values of k1 and k2
% Yp saves the most suitable values of simulated fluorescence intensity
% p chooses the different value of I
% ii/jj finds the location where the most suitable values of k1 and k2 is
% k1a/k2a refers initial value of k1/k2
% a refers fluorescence quantum yield

k1a = 1e-4;
k2a = 1e-9;
k1 = k1a;
k2 = k2a;
N = 100;
a = 3.2;
tspan = [0:10:180];
T = [25 10 5 1 0.5 1e-3];
kp = [];
Yp = [];
for p=6
x0 = [0 0 0 T(p) 200 300 300];
count = 0;
for i=1:N
    k1 = k1a+i*k1a;
    for j=1:N
        k2 = k2a+j*k2a;
        [t,Y] = ode45(@kinetics,tspan,x0);
        count = count+1;
        Y3(:,count) = a*Y(:,3);
    end
end

Y4=data(:,p);
[m,n] = size(Y3);
for i=1:n
    R(i)=1-(sum((Y3(:,i)-Y4).^2)/sum((Y4-mean(Y4)).^2)); % Goodness of Fit
end

[R1(:,p),s]=max(R);

c = 0;
for i=1:N
    for j=1:N
        c = c+1;
        if c==s 
           ii = i;
           jj = j;
        end
    end
end

k1 = k1a+ii*k1a;
k2 = k2a+jj*k2a;
kp(:,p) = [k1,k2,k1/k2];
Yp(:,p) = Y3(:,s);

plot(t,Y3(:,s),'k','linewidth',2)
hold on
plot(t,Y4,'r','linewidth',2)
hold on

end
function [dx]=kinetics(t,x)
global k1 k2;
dx = zeros(7,1); %Initiate dx
dx(1) = k1*x(4)*x(5)-k1*x(6)*x(1)+k2*x(3)*x(5)-k2*x(1)*x(6); % 1 refers I-H1
dx(2) = k1*x(6)*x(1)-k1*x(7)*x(2)+k2*x(6)*x(1)-k2*x(2)*x(7); % 2 refers I-H1-H2
dx(3) = k1*x(7)*x(2)-k2*x(3)*x(5)+k2*x(2)*x(7); % 3 refers H1-H2-H3
dx(4) = -k1*x(4)*x(5)+k1*x(2)*x(7); % 4 refers I
dx(5) = -k1*x(4)*x(5)-k2*x(3)*x(5); % 5 refers H1
dx(6) = -k1*x(1)*x(6)-k2*x(1)*x(6); % 6 refers H2
dx(7) = -k1*x(2)*x(7)-k2*x(2)*x(7); % 7 refers H3
end   